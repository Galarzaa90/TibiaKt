name: 🚀 Publish to Maven Central

on:
  push:
    branches:
      - 'main'
      - 'dev'
    tags-ignore:
      - '**'
  release:
    types: [ published ]

jobs:
  publish:
    name: 🚀 Publish to Maven Central
    runs-on: ubuntu-latest

    steps:
      - name: Checkout 📦
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed to get full tag history

      - name: Set up JDK ☕
        uses: actions/setup-java@v4
        with:
          java-version: '19'
          distribution: 'temurin'

      - name: Setup Gradle 🐘
        uses: gradle/actions/setup-gradle@v4

      - name: Resolve version via Gradle 🏷️
        shell: bash
        run: |
          OUT=$(./gradlew -q ciPrintVersion | tr -d '\r')
          echo "$OUT"
          VERSION=$(printf "%s\n" "$OUT" | sed -n 's/^VERSION=//p' | tail -n1)
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

          # Pretty summary
          {
            echo "### 🔖 Version Info"
            echo "- VERSION: \`$VERSION\`"
            echo "- $(printf "%s\n" "$OUT" | sed -n 's/^LAST_TAG=/Last tag: `/p' | sed 's/$/`/')"
            echo "- $(printf "%s\n" "$OUT" | sed -n 's/^COMMIT_DISTANCE=/Commits since tag: `/p' | sed 's/$/`/')"
            echo "- $(printf "%s\n" "$OUT" | sed -n 's/^BRANCH=/Branch: `/p' | sed 's/$/`/')"
            echo "- $(printf "%s\n" "$OUT" | sed -n 's/^CLEAN_TAG=/Clean tag: `/p' | sed 's/$/`/')"
          } >> "$GITHUB_STEP_SUMMARY"


      - name: Clean staging 🧹
        run: rm -rf build/staging-deploy || true

      - name: Deploy 🚀
        run: ./gradlew -x test publish jreleaserDeploy --scan
        env:
          JRELEASER_DEPLOY_MAVEN_MAVENCENTRAL_USERNAME: ${{ secrets.SONATYPE_USER }}
          JRELEASER_DEPLOY_MAVEN_MAVENCENTRAL_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
          JRELEASER_DEPLOY_MAVEN_NEXUS2_USERNAME: ${{ secrets.SONATYPE_USER }}
          JRELEASER_DEPLOY_MAVEN_NEXUS2_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
          JRELEASER_GPG_KEYNAME: ${{ vars.GPG_KEY_ID }}
          JRELEASER_GPG_PUBLIC_KEY: ${{ vars.GPG_PUBLIC_KEY }}
          JRELEASER_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          JRELEASER_GPG_SECRET_KEY: ${{ secrets.GPG_SECRET_KEY }}
