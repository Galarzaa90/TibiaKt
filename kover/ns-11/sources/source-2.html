


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>tibiakt-core Coverage Report > ElementsKt</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope: tibiakt-core<span class="separator">|</span>    <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.galarzaa.tibiakt.core.utils</a>
</div>

<h1>Coverage Summary for Class: ElementsKt (com.galarzaa.tibiakt.core.utils)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">ElementsKt</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    89.5%
  </span>
  <span class="absValue">
    (17/19)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    63.2%
  </span>
  <span class="absValue">
    (43/68)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    93.8%
  </span>
  <span class="absValue">
    (90/96)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    86.7%
  </span>
  <span class="absValue">
    (755/871)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright Â© 2024 Allan Galarza
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package com.galarzaa.tibiakt.core.utils
&nbsp;
&nbsp;import com.galarzaa.tibiakt.core.exceptions.ParsingException
&nbsp;import org.jsoup.Jsoup
&nbsp;import org.jsoup.nodes.Document
&nbsp;import org.jsoup.nodes.Element
&nbsp;import org.jsoup.nodes.TextNode
&nbsp;import org.jsoup.parser.Parser
&nbsp;import org.jsoup.select.Elements
&nbsp;import java.net.URL
&nbsp;
&nbsp;internal const val TABLE_SELECTOR = &quot;table.TableContent&quot;
&nbsp;
&nbsp;internal fun Element.boxContent(): Element =
<b class="pc">&nbsp;    selectFirst(&quot;div.BoxContent&quot;) ?: throw ParsingException(&quot;BoxContent container not found&quot;)</b>
&nbsp;
&nbsp;
<b class="fc">&nbsp;internal fun Element.parseTables(contentTableSelector: String = TABLE_SELECTOR): Map&lt;String, Elements&gt; {</b>
<b class="fc">&nbsp;    val tables = select(&quot;div.TableContainer&quot;)</b>
<b class="fc">&nbsp;    val output = mutableMapOf&lt;String, Elements&gt;()</b>
<b class="fc">&nbsp;    for (table: Element in tables) {</b>
<b class="fc">&nbsp;        val captionContainer = table.selectFirst(&quot;div.CaptionContainer&quot;)</b>
<b class="fc">&nbsp;        val contentTable = table.selectFirst(contentTableSelector)</b>
<b class="pc">&nbsp;        val caption = captionContainer?.text() ?: throw ParsingException(&quot;table has no caption container&quot;)</b>
<b class="fc">&nbsp;        if (contentTable == null) continue</b>
<b class="fc">&nbsp;        val rows = contentTable.select(&quot;tr&quot;)</b>
<b class="fc">&nbsp;        output[caption] = rows</b>
&nbsp;    }
<b class="fc">&nbsp;    return output</b>
&nbsp;}
&nbsp;
<b class="fc">&nbsp;internal fun Element.parseTablesMap(contentSelector: String = &quot;div.TableContentContainer&quot;): Map&lt;String, Element&gt; {</b>
<b class="fc">&nbsp;    val tables = select(&quot;div.TableContainer&quot;)</b>
<b class="fc">&nbsp;    val output = mutableMapOf&lt;String, Element&gt;()</b>
<b class="fc">&nbsp;    for (table: Element in tables) {</b>
<b class="fc">&nbsp;        val caption: String =</b>
<b class="pc">&nbsp;            table.selectFirst(&quot;div.Text&quot;)?.cleanText() ?: throw ParsingException(&quot;table has no caption&quot;)</b>
<b class="fc">&nbsp;        val contentTable = table.selectFirst(contentSelector)</b>
<b class="fc">&nbsp;        output[caption] = contentTable ?: continue</b>
&nbsp;    }
<b class="fc">&nbsp;    return output</b>
&nbsp;}
&nbsp;
&nbsp;/** Get a list of rows in the element. */
<b class="pc">&nbsp;internal fun Element?.rows(): Elements = this?.select(&quot;tr&quot;) ?: Elements()</b>
<b class="pc">&nbsp;internal fun Elements?.rows(): Elements = this?.select(&quot;tr&quot;) ?: Elements()</b>
&nbsp;
&nbsp;/** Get a list of cells found in the elmenet. */
<b class="pc">&nbsp;internal fun Element?.cells(): Elements = this?.select(&quot;td&quot;) ?: Elements()</b>
&nbsp;
&nbsp;/** Get a list of the text contained in all cells in the element.*/
<b class="fc">&nbsp;internal fun Element.cellsText(): List&lt;String&gt; = cells().map { it.cleanText() }</b>
&nbsp;
&nbsp;/** Get the text contained in an element, cleaned out of extraneous characters. */
<b class="fc">&nbsp;internal fun Element.cleanText() = text().clean()</b>
<b class="fc">&nbsp;internal fun TextNode.cleanText() = text().clean()</b>
&nbsp;
&nbsp;/** Get the text contained in a list of element, cleaned out of extraneous characters. */
<b class="nc">&nbsp;internal fun Elements.cleanText() = text().clean()</b>
&nbsp;
&nbsp;/** Get the text contained in an element, cleaned out of extraneous characters. */
<b class="fc">&nbsp;internal fun Element.wholeCleanText() = wholeText().clean()</b>
&nbsp;
&nbsp;
&nbsp;/** Replace all br tags in an element with line jumps. */
<b class="fc">&nbsp;internal fun Element.replaceBrs() = apply {</b>
<b class="fc">&nbsp;    select(&quot;br&quot;).forEach { it.replaceWith(TextNode(&quot;\n&quot;)) }</b>
<b class="fc">&nbsp;}</b>
&nbsp;
&nbsp;/** Replace all br tags in an array of elements with line jumps. */
<b class="nc">&nbsp;internal fun ArrayList&lt;Element&gt;.replaceBr() = forEach { it.replaceBrs() }</b>
&nbsp;
&nbsp;/** Get all the field&#39;s values and available options of a form element.
&nbsp; *
&nbsp; * @receiver An element with the form tag.
&nbsp; */
&nbsp;internal fun Element.formData(): FormData {
<b class="pc">&nbsp;    require(this.tagName().lowercase() == &quot;form&quot;) {</b>
<b class="nc">&nbsp;        &quot;expected element with &#39;form&#39; tag, got element with &#39;${this.tagName()}&#39; tag&quot;</b>
&nbsp;    }
<b class="fc">&nbsp;    val data = mutableMapOf&lt;String, String&gt;()</b>
<b class="fc">&nbsp;    val dataMultiple = mutableMapOf&lt;String, MutableList&lt;String&gt;&gt;()</b>
<b class="fc">&nbsp;    val availableOptions = mutableMapOf&lt;String, MutableList&lt;String&gt;&gt;()</b>
<b class="fc">&nbsp;    select(&quot;input[type=text], input[type=hidden]&quot;).forEach { data[it.attr(&quot;name&quot;)] = it.attr(&quot;value&quot;) }</b>
<b class="fc">&nbsp;    select(&quot;select&quot;).forEach {</b>
<b class="fc">&nbsp;        it.select(&quot;option&quot;).forEach { opt -&gt;</b>
<b class="fc">&nbsp;            val value = opt.attr(&quot;value&quot;)</b>
<b class="fc">&nbsp;            val name = it.attr(&quot;name&quot;)</b>
<b class="fc">&nbsp;            availableOptions.getOrPut(name) { mutableListOf() }.add(value)</b>
<b class="fc">&nbsp;            if (opt.hasAttr(&quot;selected&quot;)) data[name] = value</b>
<b class="fc">&nbsp;        }</b>
<b class="fc">&nbsp;    }</b>
<b class="fc">&nbsp;    select(&quot;input[type=checkbox]&quot;).forEach {</b>
<b class="fc">&nbsp;        val name = it.attr(&quot;name&quot;)</b>
<b class="fc">&nbsp;        val value = it.attr(&quot;value&quot;)</b>
<b class="fc">&nbsp;        availableOptions.getOrPut(name) { mutableListOf() }.add(value)</b>
<b class="fc">&nbsp;        if (it.hasAttr(&quot;checked&quot;)) dataMultiple.getOrPut(name) { mutableListOf() }.add(value)</b>
<b class="fc">&nbsp;    }</b>
<b class="fc">&nbsp;    select(&quot;input[type=radio]&quot;).forEach {</b>
<b class="fc">&nbsp;        val name = it.attr(&quot;name&quot;)</b>
<b class="fc">&nbsp;        val value = it.attr(&quot;value&quot;)</b>
<b class="fc">&nbsp;        availableOptions.getOrPut(name) { mutableListOf() }.add(value)</b>
<b class="fc">&nbsp;        if (it.hasAttr(&quot;checked&quot;)) data[name] = value</b>
<b class="fc">&nbsp;    }</b>
<b class="fc">&nbsp;    return FormData(data, dataMultiple, availableOptions, action = attr(&quot;action&quot;), method = attr(&quot;method&quot;))</b>
&nbsp;}
&nbsp;
&nbsp;/**
&nbsp; * Contains the data extracted from a form.
&nbsp; * @property values Mapping of form fields to their selected value.
&nbsp; * @property valuesMultiple Mapping of form fields that might have multiple values.
&nbsp; * @property availableOptions Mapping of the available options for selection in the form.
&nbsp; * @property action Where the form would be submitted to.
&nbsp; * @property method The HTTP method used
&nbsp; */
&nbsp;internal data class FormData(
&nbsp;    val values: Map&lt;String, String&gt; = emptyMap(),
&nbsp;    val valuesMultiple: Map&lt;String, List&lt;String&gt;&gt; = emptyMap(),
&nbsp;    val availableOptions: Map&lt;String, List&lt;String&gt;&gt; = emptyMap(),
&nbsp;    val action: String? = null,
&nbsp;    val method: String? = null,
&nbsp;)
&nbsp;
<b class="fc">&nbsp;private val pageRegex = Regex(&quot;&quot;&quot;(?:page|pagenumber)=(\d+)&quot;&quot;&quot;)</b>
<b class="fc">&nbsp;private val resultsRegex = Regex(&quot;&quot;&quot;Results: ([\d,]+)&quot;&quot;&quot;)</b>
&nbsp;
&nbsp;/** Parse the pagination block present in many Tibia.com sections. */
&nbsp;internal fun Element.parsePagination(): PaginationData {
<b class="fc">&nbsp;    val (pagesDiv, resultsDiv) = select(&quot;small &gt; div&quot;)</b>
<b class="fc">&nbsp;    val currentPageLink = pagesDiv.selectFirst(&quot;.CurrentPageLink&quot;)</b>
<b class="fc">&nbsp;    val pageLinks = pagesDiv.select(&quot;.PageLink&quot;)</b>
<b class="fc">&nbsp;    val firstOrLastPages = pagesDiv.select(&quot;.FirstOrLastElement&quot;)</b>
<b class="fc">&nbsp;    val totalPages = if (firstOrLastPages.isNotEmpty()) {</b>
<b class="pc">&nbsp;        val lastPageLink = firstOrLastPages.last()?.selectFirst(&quot;a&quot;)</b>
<b class="pc">&nbsp;        if (lastPageLink != null) {</b>
<b class="pc">&nbsp;            pageRegex.find(lastPageLink.attr(&quot;href&quot;))?.let {</b>
<b class="fc">&nbsp;                it.groups[1]!!.value.toInt()</b>
<b class="nc">&nbsp;            } ?: throw ParsingException(&quot;Could not parse pagination info&quot;)</b>
&nbsp;        } else {
<b class="nc">&nbsp;            pageLinks[pageLinks.size - 2].text().toInt()</b>
&nbsp;        }
&nbsp;    } else {
<b class="pc">&nbsp;        pageLinks.last()?.text()?.toInt() ?: throw ParsingException(&quot;could not find last page link&quot;)</b>
&nbsp;    }
<b class="fc">&nbsp;    val page = try {</b>
<b class="pc">&nbsp;        currentPageLink?.text()?.toInt() ?: totalPages</b>
&nbsp;    } catch (nfe: NumberFormatException) {
<b class="pc">&nbsp;        if (currentPageLink?.text()?.contains(&quot;First&quot;) == true) 1</b>
<b class="fc">&nbsp;        else totalPages</b>
&nbsp;    }
<b class="pc">&nbsp;    val resultsCount: Int = resultsRegex.find(resultsDiv.text())?.let {</b>
<b class="fc">&nbsp;        it.groups[1]!!.value.parseInteger()</b>
<b class="nc">&nbsp;    } ?: 0</b>
<b class="fc">&nbsp;    return PaginationData(page, totalPages, resultsCount)</b>
&nbsp;}
&nbsp;
&nbsp;/**
&nbsp; * Container for pagination information.
&nbsp; */
&nbsp;internal data class PaginationData(val currentPage: Int, val totalPages: Int, val resultsCount: Int) {
&nbsp;    companion object {
&nbsp;        fun default() = PaginationData(1, 1, 0)
&nbsp;    }
&nbsp;}
&nbsp;
&nbsp;internal fun parsePopup(content: String): Pair&lt;String, Document&gt; {
<b class="fc">&nbsp;    val parts = content.split(&quot;,&quot;, limit = 3)</b>
<b class="fc">&nbsp;    val title = parts[1].replace(&quot;&#39;&quot;, &quot;&quot;).trim()</b>
<b class="fc">&nbsp;    val html = parts[parts.size - 1].replace(&quot;\\&#39;&quot;, &quot;\&quot;&quot;).replace(&quot;&#39;&quot;, &quot;&quot;).replace(&quot;,);&quot;, &quot;&quot;).replace(&quot;, );&quot;, &quot;&quot;).trim()</b>
<b class="fc">&nbsp;    val parsedHtml = Jsoup.parse(html, &quot;&quot;, Parser.xmlParser())</b>
<b class="fc">&nbsp;    return title to parsedHtml</b>
&nbsp;}
&nbsp;
<b class="fc">&nbsp;private val queryStringRegex = Regex(&quot;([^&amp;=]+)=([^&amp;]*)&quot;)</b>
&nbsp;internal fun Element.getLinkInformation(): LinkInformation? {
<b class="pc">&nbsp;    if (this.tagName() != &quot;a&quot;) return null</b>
<b class="fc">&nbsp;    return LinkInformation(this.text(), this.attr(&quot;href&quot;))</b>
&nbsp;}
&nbsp;
&nbsp;internal data class LinkInformation(val title: String, val targetUrl: URL) {
&nbsp;    val queryParams
&nbsp;        get() = targetUrl.queryParams()
&nbsp;
&nbsp;    constructor(title: String, targetUrl: String) : this(title, URL(targetUrl))
&nbsp;
&nbsp;}
&nbsp;
&nbsp;internal fun URL.queryParams(): HashMap&lt;String, MutableList&lt;String&gt;&gt; {
<b class="fc">&nbsp;    val matches = queryStringRegex.findAll(this.query)</b>
<b class="fc">&nbsp;    val map: HashMap&lt;String, MutableList&lt;String&gt;&gt; = hashMapOf()</b>
<b class="fc">&nbsp;    for (match: MatchResult in matches) {</b>
<b class="fc">&nbsp;        val (_, name, value) = match.groupValues</b>
<b class="fc">&nbsp;        map.getOrPut(name) { mutableListOf() }.add(value)</b>
&nbsp;    }
<b class="fc">&nbsp;    return map</b>
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-07-30 03:38</div>
</div>
</body>
</html>
